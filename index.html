<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GHR BELUGA</title>
    <link rel="manifest" href="#" id="manifest-placeholder">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="GHR BELUGA">

    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiBmaWxsPSIjMjU2M2ViIiByeD0iMjAiLz4KPHN2ZyB4PSI0MCIgeT0iNDAiIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9IndoaXRlIj4KPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJjdXJyZW50Q29sb3IiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj4KPHBhdGggZD0ibTE3LjUgMTkuNS0uNS0yLjUtLjUtMi41LTUtMi41LTUtMi41LS41IDIuNS0uNSAyLjVaIi8+CjxwYXRoIGQ9Im05IDUgOCA4LTMuNS0xTDkgNVoiLz4KPHN2Zz4KPHN2Zz4KPC9zdmc+">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }

        .app-container {
            max-width: 400px;
            margin: 0 auto;
            background: #f5f5f5;
            min-height: 100vh;
            position: relative;
        }

        .header {
            background: #2563eb;
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 8px; /* Espacio debajo del t√≠tulo principal */
        }

        .header-logos {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        .header-logo {
            height: 30px; /* Tama√±o de los logos */
        }

        .content {
            padding: 20px;
            padding-bottom: 100px;
        }

        .btn {
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-success {
            background: #059669;
            color: white;
        }

        .btn-warning {
            background: #d97706;
            color: white;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
            background-color: white;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            cursor: pointer;
        }
        
        .form-input-half {
            width: calc(50% - 6px);
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #2563eb;
        }

        .operation-item {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-left: 4px solid #2563eb;
        }

        .operation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .operation-title {
            font-weight: 600;
            color: #1f2937;
        }

        .operation-time {
            color: #059669;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            font-weight: 600;
        }

        .operation-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn-sm {
            padding: 8px 12px;
            font-size: 14px;
            min-width: auto;
            margin: 0;
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-icon:active {
            transform: scale(0.9);
        }

        .btn-icon.minus {
            background: #fee2e2;
            color: #dc2626;
        }

        .btn-icon.plus {
            background: #dcfce7;
            color: #16a34a;
        }

        .btn-icon.edit {
            background: #dbeafe;
            color: #2563eb;
        }

        .payload-input {
            width: 100px;
            padding: 8px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            margin-right: 8px;
        }

        .flight-info {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .flight-info h2 {
            font-size: 20px;
            margin-bottom: 8px;
        }

        .flight-info p {
            opacity: 0.9;
            margin-bottom: 4px;
        }

        .history-item {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 12px;
        }

        .history-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px 16px;
            font-size: 14px;
            color: #4b5563;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .detail-label {
            font-weight: 600;
            color: #1f2937;
        }

        .detail-value {
            font-family: monospace;
            font-size: 12px;
        }

        .history-operations {
            max-height: 200px;
            overflow-y: auto;
            background: #f9fafb;
            border-radius: 8px;
            padding: 12px;
            margin-top: 16px;
        }

        .history-operation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 4px;
            background: white;
            border-radius: 6px;
            font-size: 14px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 400px;
            background: white;
            padding: 12px 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex;
            gap: 12px;
        }

        .hidden {
            display: none !important;
        }

        .install-banner {
            background: #059669;
            color: white;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
        }
        
        @media (display-mode: standalone) {
            .install-banner {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div id="installBanner" class="install-banner">
            üì± Toca aqu√≠ para instalar GHR BELUGA como app
        </div>

        <div class="header">
            <h1>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="m17.5 19.5-.5-2.5-.5-2.5-5-2.5-5-2.5-.5 2.5-.5 2.5Z"/>
                    <path d="m9 5 8 8-3.5-1L9 5Z"/>
                </svg>
                GHR BELUGA
            </h1>
        </div>

        <div class="content">
            <div id="listView">
                <div id="newFlightForm" class="hidden">
                    <div class="card">
                        <form id="flightForm">
                            <div class="form-group">
                                <label class="form-label">N√∫mero de Registro</label>
                                <input type="text" id="registrationNumber" class="form-input" placeholder="Ej: F-GHRB" required>
                            </div>
                            <div style="display: flex; gap: 12px;">
                                <div class="form-group" style="flex: 1;">
                                    <label class="form-label">Vuelo Llegada</label>
                                    <input type="text" id="arrivalFlight" class="form-input" placeholder="Ej: BGA9212">
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label class="form-label">Vuelo Salida</label>
                                    <input type="text" id="departureFlight" class="form-input" placeholder="Ej: BGA9213">
                                </div>
                            </div>
                            <div style="display: flex; gap: 12px;">
                                <div class="form-group" style="flex: 1;">
                                    <label class="form-label">Aeropuerto Llegada</label>
                                    <select id="arrivalAirport" class="form-select"></select>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label class="form-label">Aeropuerto Salida</label>
                                    <select id="departureAirport" class="form-select"></select>
                                </div>
                            </div>
                            <div style="display: flex; gap: 12px;">
                                <div class="form-group" style="flex: 1;">
                                    <label class="form-label">STA</label>
                                    <input type="time" id="sta" class="form-input">
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label class="form-label">STD</label>
                                    <input type="time" id="std" class="form-input">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Coordinador</label>
                                <select id="coordinator" class="form-select"></select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Conductor</label>
                                <select id="driver" class="form-select"></select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Wingwalker 1</label>
                                <select id="wingwalker1" class="form-select"></select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Wingwalker 2</label>
                                <select id="wingwalker2" class="form-select"></select>
                            </div>

                            <div style="display: flex; gap: 12px;">
                                <button type="submit" class="btn btn-primary" style="flex: 1;">Crear Vuelo</button>
                                <button type="button" id="cancelNewFlight" class="btn" style="background: #e5e7eb; color: #374151;">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>

                <button id="newFlightBtn" class="btn btn-primary">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Nuevo Vuelo
                </button>

                <button id="continueFlightBtn" class="btn btn-warning hidden">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12,6 12,12 16,14"></polyline>
                    </svg>
                    Continuar Vuelo
                </button>

                <button id="historyBtn" class="btn btn-success">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path d="m3 12 2-2m0 0 7-7 7 7M5 10v10a1 1 0 0 0 1 1h3m10-11 2 2m-2-2v10a1 1 0 0 0 1 1h3m-6 0a1 1 0 0 0 1-1v-4a1 1 0 0 0-1-1h-2a1 1 0 0 0-1 1v4a1 1 0 0 0 1 1h2z"/>
                    </svg>
                    Ver Historial (<span id="historyCount">0</span>)
                </button>
            </div>

            <div id="currentFlightView" class="hidden">
                <div id="flightInfo" class="flight-info">
                    <h2 id="currentFlightTitle">Vuelo</h2>
                    <p id="currentFlightReg">Registro:</p>
                    <p id="currentFlightArr">Vuelo Llegada:</p>
                    <p id="currentFlightDep">Vuelo Salida:</p>
                    <p id="currentFlightArrAp">Aeropuerto Llegada:</p>
                    <p id="currentFlightDepAp">Aeropuerto Salida:</p>
                    <p id="currentFlightSTA">STA:</p>
                    <p id="currentFlightSTD">STD:</p>
                    <p id="currentFlightCoordinator">Coordinador:</p>
                    <p id="currentFlightDriver">Conductor:</p>
                    <p id="currentFlightWW1">Wingwalker 1:</p>
                    <p id="currentFlightWW2">Wingwalker 2:</p>
                    <p id="currentFlightDate">Fecha:</p>
                    <p id="currentFlightTime">Inicio:</p>
                </div>

                <div id="operationsList"></div>
            </div>

            <div id="historyView" class="hidden">
                <div class="card" style="display: flex; gap: 12px; margin-bottom: 20px;">
                    <button id="exportBtn" class="btn btn-success" style="flex: 1; padding: 12px; font-size: 14px;">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4m4-5 5 5 5-5M12 17V3"></path>
                        </svg>
                        Exportar
                    </button>
                    <button id="importBtn" class="btn btn-primary" style="flex: 1; padding: 12px; font-size: 14px;">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4m4-5 5-5 5 5M12 3v14"></path>
                        </svg>
                        Importar
                    </button>
                </div>
                <div id="historyList"></div>
                <div id="emptyHistory" class="hidden" style="text-align: center; color: #6b7280; padding: 40px 0;">
                    No hay vuelos completados a√∫n
                </div>
                <input type="file" id="fileInput" accept="application/json" style="display:none;">
            </div>
        </div>

        <div id="bottomNav" class="bottom-nav hidden">
            <button id="backBtn" class="btn btn-primary" style="flex: 1;">‚Üê Volver</button>
            <button id="saveBtn" class="btn btn-success hidden" style="flex: 1;">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path d="m9 12 2 2 4-4"></path>
                    <path d="M21 12c.552 0 1-.448 1-1V8a2 2 0 0 0-2-2h-5L9 2H4a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2z"></path>
                </svg>
                Guardar
            </button>
        </div>
    </div>

    <script>
        // PWA Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:text/javascript,')
            .catch(() => {});
        }

        // Variables globales
        let flights = [];
        let currentFlight = null;
        let currentView = 'list';

        const coordinatorOptions = ["", "Sergio Iacobone", "Francisco Cartas", "Fernando Perez", "Paco Mu√±oz"];
        const driverOptions = ["", "Fidel Botey", "Juan Gamez", "Paco Jerez", "Gaspar Franco"];
        const wingwalkerOptions = ["", ...coordinatorOptions.slice(1), ...driverOptions.slice(1)];
        const airportOptions = ["", "Chester CEG", "Toulouse TLS", "Hamburgo XFW", "Bremen BRE", "Saint-Nazaire SNR"];

        const operations = [
            'OPERATIVA', 'PAYLOAD', 'LLEGADA', 'SALIDA', 'ATA', 'PARADA MOTORES',
            'START TOWING', 'END TOWING', 'GPU ON', 'GPU OFF', 'FRONT JACK UP',
            'REAR JACK UP', 'FUEL', 'ACU ON', 'ACU OFF', 'REAR JACK DOWN',
            'FRONT JACK DOWN', 'START TOWING', 'END TOWING', 'STARTUP', 'TAXI', 'TAKEOFF'
        ];

        // Cargar datos
        function loadData() {
            const saved = localStorage.getItem('ghrBelugaFlights');
            if (saved) {
                flights = JSON.parse(saved);
            }
            updateHistoryCount();
        }

        // Guardar datos
        function saveData() {
            localStorage.setItem('ghrBelugaFlights', JSON.stringify(flights));
            updateHistoryCount();
        }

        // Actualizar contador de historial
        function updateHistoryCount() {
            document.getElementById('historyCount').textContent = flights.filter(f => f.completed).length;
        }

        // Cambiar vista
        function showView(view) {
            document.querySelectorAll('#listView, #currentFlightView, #historyView').forEach(v => {
                v.classList.add('hidden');
            });

            if (view === 'list') {
                document.getElementById('listView').classList.remove('hidden');
                document.getElementById('bottomNav').classList.add('hidden');
                updateContinueButton();
            } else if (view === 'current') {
                document.getElementById('currentFlightView').classList.remove('hidden');
                document.getElementById('bottomNav').classList.remove('hidden');
                document.getElementById('saveBtn').classList.remove('hidden');
                updateCurrentFlightView();
            } else if (view === 'history') {
                document.getElementById('historyView').classList.remove('hidden');
                document.getElementById('bottomNav').classList.remove('hidden');
                document.getElementById('saveBtn').classList.add('hidden');
                updateHistoryView();
            }

            currentView = view;
        }

        // Actualizar bot√≥n continuar
        function updateContinueButton() {
            const btn = document.getElementById('continueFlightBtn');
            const uncompletedFlight = flights.find(f => !f.completed);
            if (uncompletedFlight) {
                currentFlight = uncompletedFlight;
                btn.classList.remove('hidden');
                btn.innerHTML = `
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12,6 12,12 16,14"></polyline>
                    </svg>
                    Continuar Vuelo ${currentFlight.registrationNumber}
                `;
            } else {
                currentFlight = null;
                btn.classList.add('hidden');
            }
        }

        // Crear nuevo vuelo
        function createFlight(data) {
            currentFlight = {
                id: Date.now(),
                ...data,
                date: new Date().toLocaleDateString('es-ES'),
                startTime: new Date().toLocaleTimeString('es-ES'),
                operations: {},
                completed: false
            };
            showView('current');
        }

        // Registrar operaci√≥n
        function recordOperation(operation) {
            if (!currentFlight) return;

            const currentTime = new Date().toLocaleTimeString('es-ES');
            currentFlight.operations[operation] = currentTime;
            updateCurrentFlightView();
        }

        // Registrar payload
        function recordPayload(value) {
            if (!currentFlight || !value.trim()) return;

            currentFlight.operations['PAYLOAD'] = value.trim();
            updateCurrentFlightView();
        }

        // Ajustar tiempo
        function adjustTime(operation, minutes) {
            if (!currentFlight?.operations[operation]) return;

            const currentTime = currentFlight.operations[operation];
            const [hours, mins, secs] = currentTime.split(':').map(Number);

            let totalMinutes = hours * 60 + mins + minutes;
            if (totalMinutes < 0) totalMinutes = 0;
            if (totalMinutes >= 24 * 60) totalMinutes = 24 * 60 - 1;

            const newHours = Math.floor(totalMinutes / 60);
            const newMins = totalMinutes % 60;
            const newTime = `${newHours.toString().padStart(2, '0')}:${newMins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

            currentFlight.operations[operation] = newTime;
            updateCurrentFlightView();
        }

        // Actualizar vista de vuelo actual
        function updateCurrentFlightView() {
            if (!currentFlight) return;

            document.getElementById('currentFlightTitle').textContent = `Vuelo ${currentFlight.registrationNumber}`;
            document.getElementById('currentFlightReg').textContent = `Registro: ${currentFlight.registrationNumber || 'N/A'}`;
            document.getElementById('currentFlightArr').textContent = `Vuelo Llegada: ${currentFlight.arrivalFlight || 'N/A'}`;
            document.getElementById('currentFlightDep').textContent = `Vuelo Salida: ${currentFlight.departureFlight || 'N/A'}`;
            document.getElementById('currentFlightArrAp').textContent = `Aeropuerto Llegada: ${currentFlight.arrivalAirport || 'N/A'}`;
            document.getElementById('currentFlightDepAp').textContent = `Aeropuerto Salida: ${currentFlight.departureAirport || 'N/A'}`;
            document.getElementById('currentFlightSTA').textContent = `STA: ${currentFlight.sta || 'N/A'}`;
            document.getElementById('currentFlightSTD').textContent = `STD: ${currentFlight.std || 'N/A'}`;
            document.getElementById('currentFlightCoordinator').textContent = `Coordinador: ${currentFlight.coordinator || 'N/A'}`;
            document.getElementById('currentFlightDriver').textContent = `Conductor: ${currentFlight.driver || 'N/A'}`;
            document.getElementById('currentFlightWW1').textContent = `Wingwalker 1: ${currentFlight.wingwalker1 || 'N/A'}`;
            document.getElementById('currentFlightWW2').textContent = `Wingwalker 2: ${currentFlight.wingwalker2 || 'N/A'}`;
            document.getElementById('currentFlightDate').textContent = `Fecha: ${currentFlight.date}`;
            document.getElementById('currentFlightTime').textContent = `Inicio: ${currentFlight.startTime}`;

            const operationsList = document.getElementById('operationsList');
            operationsList.innerHTML = '';

            operations.forEach(operation => {
                const div = document.createElement('div');
                div.className = 'operation-item';

                const hasValue = currentFlight.operations[operation];

                div.innerHTML = `
                    <div class="operation-header">
                        <div class="operation-title">${operation}</div>
                        ${hasValue ? `<div class="operation-time">${hasValue}</div>` : ''}
                    </div>
                    <div class="operation-controls">
                        ${operation === 'PAYLOAD' ? `
                            <input type="text" id="payload-${operation}" class="payload-input" placeholder="Ej: 12.5 ton">
                            <button onclick="recordPayload(document.getElementById('payload-${operation}').value); document.getElementById('payload-${operation}').value = '';" class="btn btn-sm btn-primary">Guardar</button>
                        ` : `
                            <button onclick="recordOperation('${operation}')" class="btn btn-sm ${hasValue ? 'btn-success' : 'btn-primary'}">
                                ${hasValue ? 'Actualizar' : 'Registrar'}
                            </button>
                            ${hasValue ? `
                                <button onclick="adjustTime('${operation}', -1)" class="btn-icon minus" title="Restar 1 minuto">-</button>
                                <button onclick="adjustTime('${operation}', 1)" class="btn-icon plus" title="Sumar 1 minuto">+</button>
                            ` : ''}
                        `}
                    </div>
                `;

                operationsList.appendChild(div);
            });
        }

        // Guardar vuelo
        function saveFlight() {
            if (!currentFlight) return;

            currentFlight.completed = true;
            currentFlight.endTime = new Date().toLocaleTimeString('es-ES');

            const existingIndex = flights.findIndex(f => f.id === currentFlight.id);
            if (existingIndex >= 0) {
                flights[existingIndex] = currentFlight;
            } else {
                flights.push(currentFlight);
            }

            saveData();
            currentFlight = null;
            showView('list');
        }

        // Actualizar vista de historial
        function updateHistoryView() {
            const historyList = document.getElementById('historyList');
            const emptyHistory = document.getElementById('emptyHistory');

            const completedFlights = flights.filter(f => f.completed);

            if (completedFlights.length === 0) {
                historyList.innerHTML = '';
                emptyHistory.classList.remove('hidden');
                return;
            }

            emptyHistory.classList.add('hidden');
            historyList.innerHTML = '';

            completedFlights.reverse().forEach(flight => {
                const div = document.createElement('div');
                div.className = 'history-item';

                const detailsHtml = `
                    <div class="detail-item">
                        <span class="detail-label">Vuelo Llegada:</span>
                        <span class="detail-value">${flight.arrivalFlight || 'N/A'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Vuelo Salida:</span>
                        <span class="detail-value">${flight.departureFlight || 'N/A'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Aeropuerto Llegada:</span>
                        <span class="detail-value">${flight.arrivalAirport || 'N/A'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Aeropuerto Salida:</span>
                        <span class="detail-value">${flight.departureAirport || 'N/A'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">STA:</span>
                        <span class="detail-value">${flight.sta || 'N/A'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">STD:</span>
                        <span class="detail-value">${flight.std || 'N/A'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Coordinador:</span>
                        <span class="detail-value">${flight.coordinator || 'N/A'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Conductor:</span>
                        <span class="detail-value">${flight.driver || 'N/A'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Wingwalker 1:</span>
                        <span class="detail-value">${flight.wingwalker1 || 'N/A'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Wingwalker 2:</span>
                        <span class="detail-value">${flight.wingwalker2 || 'N/A'}</span>
                    </div>
                `;

                const operationsHtml = Object.entries(flight.operations)
                    .map(([op, time]) => `
                        <div class="history-operation">
                            <span>${op}</span>
                            <span style="color: #059669; font-family: monospace;">${time}</span>
                        </div>
                    `).join('');

                div.innerHTML = `
                    <div class="history-header">
                        <div>
                            <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 4px;">Vuelo ${flight.registrationNumber}</h3>
                            <p style="color: #6b7280; font-size: 14px;">Fecha: ${flight.date}</p>
                            <p style="color: #6b7280; font-size: 14px;">Tiempo: ${flight.startTime} - ${flight.endTime}</p>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="editFlight(${flight.id})" class="btn-icon edit" title="Editar vuelo">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                            <button onclick="deleteFlight(${flight.id})" class="btn-icon minus" title="Eliminar vuelo">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <polyline points="3,6 5,6 21,6"></polyline>
                                    <path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6m3,0V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="history-details">
                        ${detailsHtml}
                    </div>
                    <div class="history-operations">
                        ${operationsHtml}
                    </div>
                    <div style="margin-top: 12px; font-size: 14px; color: #6b7280; text-align: center;">
                        ${Object.keys(flight.operations).length} operaciones registradas
                    </div>
                `;

                historyList.appendChild(div);
            });
        }

        // Editar vuelo
        function editFlight(flightId) {
            const flightToEdit = flights.find(f => f.id === flightId);
            if (flightToEdit) {
                currentFlight = flightToEdit;
                currentFlight.completed = false; // Vuelo en edici√≥n
                showView('current');
            }
        }

        // Eliminar vuelo
        function deleteFlight(flightId) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar este vuelo?')) {
                flights = flights.filter(f => f.id !== flightId);
                saveData();
                updateHistoryView();
            }
        }
        
        // Exportar datos a JSON
        function exportData() {
            const dataStr = JSON.stringify(flights, null, 2);
            const blob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ghr-beluga-vuelos-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert('Historial exportado con √©xito!');
        }

        // Importar datos desde JSON
        function importData() {
            const fileInput = document.getElementById('fileInput');
            fileInput.click();
            fileInput.onchange = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedFlights = JSON.parse(e.target.result);
                        if (Array.isArray(importedFlights)) {
                            flights = [...flights, ...importedFlights];
                            saveData();
                            updateHistoryView();
                            alert('Vuelos importados con √©xito!');
                        } else {
                            throw new Error('Formato de archivo incorrecto.');
                        }
                    } catch (error) {
                        alert('Error al importar el archivo: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
        }

        // Generar opciones para los selects de la tripulaci√≥n
        function generateCrewOptions() {
            const coordinatorSelect = document.getElementById('coordinator');
            const driverSelect = document.getElementById('driver');
            const ww1Select = document.getElementById('wingwalker1');
            const ww2Select = document.getElementById('wingwalker2');

            // Populate Coordinator dropdown
            coordinatorSelect.innerHTML = '';
            coordinatorOptions.forEach(member => {
                const option = document.createElement('option');
                option.value = member;
                option.textContent = member || "Seleccionar...";
                coordinatorSelect.appendChild(option);
            });

            // Populate Driver dropdown
            driverSelect.innerHTML = '';
            driverOptions.forEach(member => {
                const option = document.createElement('option');
                option.value = member;
                option.textContent = member || "Seleccionar...";
                driverSelect.appendChild(option);
            });

            // Populate Wingwalker dropdowns with the combined list
            [ww1Select, ww2Select].forEach(select => {
                select.innerHTML = '';
                wingwalkerOptions.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member;
                    option.textContent = member || "Seleccionar...";
                    select.appendChild(option);
                });
            });
        }

        // Generar opciones para los selects de aeropuertos
        function generateAirportOptions() {
            const arrivalAirportSelect = document.getElementById('arrivalAirport');
            const departureAirportSelect = document.getElementById('departureAirport');

            [arrivalAirportSelect, departureAirportSelect].forEach(select => {
                select.innerHTML = '';
                airportOptions.forEach(airport => {
                    const option = document.createElement('option');
                    option.value = airport;
                    option.textContent = airport || "Seleccionar...";
                    select.appendChild(option);
                });
            });
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            generateCrewOptions();
            generateAirportOptions();

            // Nuevo vuelo
            document.getElementById('newFlightBtn').addEventListener('click', () => {
                document.getElementById('newFlightBtn').classList.add('hidden');
                document.getElementById('continueFlightBtn').classList.add('hidden');
                document.getElementById('historyBtn').classList.add('hidden');
                document.getElementById('newFlightForm').classList.remove('hidden');
                document.getElementById('flightForm').reset();
                document.getElementById('registrationNumber').focus();
            });
            
            // Cancelar nuevo vuelo
            document.getElementById('cancelNewFlight').addEventListener('click', () => {
                document.getElementById('newFlightBtn').classList.remove('hidden');
                document.getElementById('continueFlightBtn').classList.remove('hidden');
                document.getElementById('historyBtn').classList.remove('hidden');
                document.getElementById('newFlightForm').classList.add('hidden');
            });

            // Form de nuevo vuelo
            document.getElementById('flightForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const flightData = {
                    registrationNumber: document.getElementById('registrationNumber').value.trim(),
                    arrivalFlight: document.getElementById('arrivalFlight').value.trim(),
                    departureFlight: document.getElementById('departureFlight').value.trim(),
                    arrivalAirport: document.getElementById('arrivalAirport').value.trim() || 'N/A',
                    departureAirport: document.getElementById('departureAirport').value.trim() || 'N/A',
                    sta: document.getElementById('sta').value.trim(),
                    std: document.getElementById('std').value.trim(),
                    coordinator: document.getElementById('coordinator').value.trim() || 'N/A',
                    driver: document.getElementById('driver').value.trim() || 'N/A',
                    wingwalker1: document.getElementById('wingwalker1').value.trim() || 'N/A',
                    wingwalker2: document.getElementById('wingwalker2').value.trim() || 'N/A'
                };
                if (flightData.registrationNumber) {
                    // Check for ongoing flight before creating a new one
                    if (flights.some(f => !f.completed)) {
                        alert('Por favor, guarda o cancela el vuelo en curso antes de crear uno nuevo.');
                    } else {
                        createFlight(flightData);
                    }
                }
            });

            // Continuar vuelo
            document.getElementById('continueFlightBtn').addEventListener('click', () => {
                showView('current');
            });

            // Ver historial
            document.getElementById('historyBtn').addEventListener('click', () => {
                showView('history');
            });

            // Volver
            document.getElementById('backBtn').addEventListener('click', () => {
                showView('list');
            });

            // Guardar
            document.getElementById('saveBtn').addEventListener('click', saveFlight);

            // Exportar e Importar
            document.getElementById('exportBtn').addEventListener('click', exportData);
            document.getElementById('importBtn').addEventListener('click', importData);
            
            // PWA Install
            let deferredPrompt;

            window.addEventListener('beforeinstallprompt', (e) => {
                deferredPrompt = e;
                document.getElementById('installBanner').style.display = 'block';
            });

            document.getElementById('installBanner').addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    deferredPrompt = null;
                    if (outcome === 'accepted') {
                        document.getElementById('installBanner').style.display = 'none';
                    }
                }
            });
        });

        // Manifest din√°mico
        const manifest = {
            "name": "GHR BELUGA",
            "short_name": "GHR BELUGA",
            "description": "Aplicaci√≥n para operaciones de vuelo",
            "start_url": "./",
            "display": "standalone",
            "background_color": "#2563eb",
            "theme_color": "#2563eb",
            "orientation": "portrait",
            "icons": [
                {
                    "src": "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiBmaWxsPSIjMjU2M2ViIiByeD0iMjQiLz4KPHN2ZyB4PSI0OCIgeT0iNDgiIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+CjxwYXRoIGQ9Im0xNy41IDE5LjUtLjUtMi41LS41LTIuNS01LTIuNS01LTIuNS0uNSAyLjUtLjUgMi41WiIvPgo8cGF0aCBkPSJtOSA1IDggOC0zLjUtMUw5IDVaIi8+Cjwvc3ZnPgo8L3N2Zz4=",
                    "sizes": "192x192",
                    "type": "image/svg+xml"
                },
                {
                    "src": "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgdmlld0JveD0iMCAwIDUxMiA1MTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIiBmaWxsPSIjMjU2M2ViIiByeD0iNjQiLz4KPHN2ZyB4PSIxMjgiIHk9IjEyOCIgd2lkdGg9IjI1NiIgaGVpZ2h0PSIyNTYiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPgo8cGF0aCBkPSJtMTcuNSAxOS41LS41LTIuNS0uNS0yLjUtNS0yLjUtNS0yLjUtLjUgMi41LS41IDIuNVoiLz4KPHBhdGggZD0ibTkgNSA4IDgtMy41LTFMOSA1WiIvPgo8L3N2Zz4KPC9zdmc+",
                    "sizes": "512x512",
                    "type": "image/svg+xml"
                }
            ]
        };

        const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(manifestBlob);
        document.getElementById('manifest-placeholder').href = manifestURL;
    </script>
</body>
</html>
