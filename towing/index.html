<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>App de Vuelo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* Prevent scrolling of the whole page on touch devices */
            touch-action: none;
        }
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.6);
                opacity: 0.7;
            }
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        /* Style for the map container to enable zoom/pan */
        #map-container {
            cursor: grab;
        }
        #map-container:active {
            cursor: grabbing;
        }
        #map-content {
            transform-origin: 0 0;
            transition: transform 0.1s ease-out;
        }
    </style>
</head>
<body class="bg-gray-900 text-white h-screen">

    <!-- Vista del Menú Principal -->
    <div id="main-app-view" class="flex flex-col h-full p-4">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-white">Mi Aplicación de Vuelo</h1>
            <p class="text-gray-400">Selecciona una opción</p>
        </header>
        <main class="flex-grow flex flex-col justify-center items-center space-y-4">
            <button class="w-full max-w-sm p-4 bg-gray-700 rounded-lg font-semibold text-lg hover:bg-gray-600 transition-colors">Nuevo Vuelo</button>
            <button class="w-full max-w-sm p-4 bg-gray-700 rounded-lg font-semibold text-lg hover:bg-gray-600 transition-colors">Estadísticas</button>
            <button class="w-full max-w-sm p-4 bg-gray-700 rounded-lg font-semibold text-lg hover:bg-gray-600 transition-colors">Historial</button>
            <button id="show-towing-btn" class="w-full max-w-sm p-4 bg-blue-600 rounded-lg font-semibold text-lg hover:bg-blue-500 transition-colors">
                Towing
            </button>
        </main>
    </div>

    <!-- Vista de la App de Towing (inicialmente oculta) -->
    <div id="towing-app-view" class="flex flex-col h-screen overflow-hidden" style="display: none;">
        <header class="bg-gray-800 p-4 shadow-lg text-center relative">
            <button id="back-to-main-btn" class="absolute left-2 top-1/2 -translate-y-1/2 p-2 rounded-full hover:bg-gray-700 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
            </button>
            <h1 class="text-xl md:text-2xl font-bold">Navegador de Rodaje</h1>
            <p id="current-airport-name" class="text-sm text-gray-400">Selecciona un aeropuerto</p>
        </header>

        <div class="flex justify-center items-center p-2 bg-gray-800 border-b border-gray-700">
            <div class="flex space-x-2">
                <button id="lemd-btn" class="px-4 py-2 bg-blue-600 rounded-md font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-colors">LEMD</button>
                <button id="legt-btn" class="px-4 py-2 bg-gray-600 rounded-md font-semibold hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50 transition-colors">LEGT</button>
                <button id="load-custom-chart-btn" class="px-4 py-2 bg-green-600 rounded-md font-semibold hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 transition-colors">Cargar Carta</button>
                <button id="reset-view-btn" title="Restablecer Vista" class="p-2 bg-gray-600 rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.885-.666A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>

        <main class="flex-grow relative overflow-hidden bg-gray-700">
            <!-- Viewport for panning and zooming -->
            <div id="map-container" class="w-full h-full">
                <!-- Content that will be transformed (panned/zoomed) -->
                <div id="map-content" class="w-full h-full relative">
                    <img id="airport-chart" src="" alt="Carta del aeropuerto" class="w-full h-full object-contain">
                    <div id="image-error" class="absolute inset-0 flex-col justify-center items-center bg-gray-700 text-center p-4" style="display: none;">
                        <p class="text-lg text-yellow-400">No se pudo cargar la carta</p>
                        <p class="text-sm text-gray-300">Asegúrate de que los ficheros .png están en la misma carpeta.</p>
                    </div>
                    <div id="user-dot" class="absolute w-5 h-5 bg-blue-400 rounded-full border-2 border-white shadow-lg pulse" style="display: none; transform: translate(-50%, -50%);"></div>
                </div>
            </div>
        </main>

        <footer id="status-panel" class="bg-gray-800 p-3 text-center text-sm md:text-base border-t border-gray-700">
            <p id="status-text">Iniciando geolocalización...</p>
            <p id="coords-text" class="text-xs text-gray-400"></p>
        </footer>

        <div id="permission-modal" class="absolute inset-0 bg-gray-900 bg-opacity-95 flex-col justify-center items-center text-center p-8" style="display: none; z-index: 50;">
             <div class="bg-gray-800 p-6 rounded-lg shadow-xl max-w-md border border-yellow-500/50">
                <h2 class="text-2xl font-bold mb-4 text-yellow-400">Permiso de Ubicación Necesario</h2>
                <p class="mb-4">Esta aplicación necesita acceder a tu ubicación para mostrar tu posición en la carta de rodaje.</p>
                <p class="mb-6 text-sm text-gray-400">Por favor, habilita los permisos de ubicación en los ajustes de tu navegador para este sitio y luego recarga la página.</p>
                <button id="reload-btn" class="w-full px-4 py-3 bg-blue-600 rounded-md font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-colors">
                    Recargar Página
                </button>
            </div>
        </div>
    </div>
    
    <input type="file" id="chart-file-input" accept="image/*" style="display: none;">

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const mainAppView = document.getElementById('main-app-view');
            const towingAppView = document.getElementById('towing-app-view');
            const showTowingBtn = document.getElementById('show-towing-btn');
            const backToMainBtn = document.getElementById('back-to-main-btn');
            const lemdBtn = document.getElementById('lemd-btn');
            const legtBtn = document.getElementById('legt-btn');
            const loadCustomChartBtn = document.getElementById('load-custom-chart-btn');
            const resetViewBtn = document.getElementById('reset-view-btn');
            const chartFileInput = document.getElementById('chart-file-input');
            const airportChart = document.getElementById('airport-chart');
            const imageError = document.getElementById('image-error');
            const userDot = document.getElementById('user-dot');
            const statusText = document.getElementById('status-text');
            const coordsText = document.getElementById('coords-text');
            const currentAirportName = document.getElementById('current-airport-name');
            const mapContainer = document.getElementById('map-container');
            const mapContent = document.getElementById('map-content');
            const permissionModal = document.getElementById('permission-modal');
            const reloadBtn = document.getElementById('reload-btn');

            // --- GESTIÓN DE VISTAS ---
            showTowingBtn.addEventListener('click', () => {
                mainAppView.style.display = 'none';
                towingAppView.style.display = 'flex';
            });

            backToMainBtn.addEventListener('click', () => {
                towingAppView.style.display = 'none';
                mainAppView.style.display = 'flex';
            });

            // --- DATOS DE AEROPUERTOS ---
            const airports = {
                'LEMD': {
                    name: 'Adolfo Suárez Madrid-Barajas',
                    imageUrl: 'lemd.png', 
                    // Coordenadas precisas extraídas de la carta de LEMD
                    bounds: { 
                        top: 40 + 32/60,    // 40°32'N
                        bottom: 40 + 28/60,  // 40°28'N
                        left: -(3 + 36/60),  // 3°36'W
                        right: -(3 + 31/60)  // 3°31'W
                    }
                },
                'LEGT': {
                    name: 'Base Aérea de Getafe',
                    imageUrl: 'legt.png',
                    // Coordenadas precisas extraídas de la carta de LEGT
                    bounds: { 
                        top: 40 + 18.2/60,   // 40°18.2'N (Ajustado para el borde superior de la imagen)
                        bottom: 40 + 16.8/60, // 40°16.8'N (Ajustado para el borde inferior de la imagen)
                        left: -(3 + 44.2/60), // 3°44.2'W (Ajustado para el borde izquierdo de la imagen)
                        right: -(3 + 41.8/60) // 3°41.8'W (Ajustado para el borde derecho de la imagen)
                    } 
                }
            };
            let currentAirportCode = null;

            // --- LÓGICA DE PAN & ZOOM ---
            let scale = 1, translateX = 0, translateY = 0;
            let isPanning = false;
            let startPanX = 0, startPanY = 0;
            let lastPinchDist = 0;

            function applyTransform() {
                mapContent.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
            }

            function getPinchDist(e) {
                const t1 = e.touches[0], t2 = e.touches[1];
                return Math.sqrt(Math.pow(t1.clientX - t2.clientX, 2) + Math.pow(t1.clientY - t2.clientY, 2));
            }

            function getMidpoint(e) {
                const t1 = e.touches[0], t2 = e.touches[1];
                return { x: (t1.clientX + t2.clientX) / 2, y: (t1.clientY + t2.clientY) / 2 };
            }

            mapContainer.addEventListener('mousedown', e => { e.preventDefault(); isPanning = true; startPanX = e.clientX - translateX; startPanY = e.clientY - translateY; });
            mapContainer.addEventListener('touchstart', e => {
                if (e.touches.length === 1) { isPanning = true; startPanX = e.touches[0].clientX - translateX; startPanY = e.touches[0].clientY - translateY; } 
                else if (e.touches.length === 2) { isPanning = false; lastPinchDist = getPinchDist(e); }
            });
            mapContainer.addEventListener('mousemove', e => { if (!isPanning) return; e.preventDefault(); translateX = e.clientX - startPanX; translateY = e.clientY - startPanY; applyTransform(); });
            mapContainer.addEventListener('touchmove', e => {
                e.preventDefault();
                if (e.touches.length === 1 && isPanning) { translateX = e.touches[0].clientX - startPanX; translateY = e.touches[0].clientY - startPanY; applyTransform(); } 
                else if (e.touches.length === 2) {
                    const newDist = getPinchDist(e); const midpoint = getMidpoint(e); const rect = mapContainer.getBoundingClientRect();
                    const mouseX = midpoint.x - rect.left; const mouseY = midpoint.y - rect.top;
                    const scaleFactor = newDist / lastPinchDist; const newScale = Math.max(1, Math.min(scale * scaleFactor, 10));
                    translateX = mouseX - (mouseX - translateX) * (newScale / scale); translateY = mouseY - (mouseY - translateY) * (newScale / scale);
                    scale = newScale; lastPinchDist = newDist; applyTransform();
                }
            });
            mapContainer.addEventListener('mouseup', () => isPanning = false);
            mapContainer.addEventListener('mouseleave', () => isPanning = false);
            mapContainer.addEventListener('touchend', e => { if (e.touches.length < 2) lastPinchDist = 0; if (e.touches.length < 1) isPanning = false; });
            mapContainer.addEventListener('wheel', e => {
                e.preventDefault(); const rect = mapContainer.getBoundingClientRect(); const scaleFactor = e.deltaY > 0 ? 0.9 : 1.1;
                const newScale = Math.max(1, Math.min(scale * scaleFactor, 10)); if (newScale === scale) return;
                const mouseX = e.clientX - rect.left; const mouseY = e.clientY - rect.top;
                translateX = mouseX - (mouseX - translateX) * (newScale / scale); translateY = mouseY - (mouseY - translateY) * (newScale / scale);
                scale = newScale; applyTransform();
            });
            resetViewBtn.addEventListener('click', () => { scale = 1; translateX = 0; translateY = 0; applyTransform(); });

            // --- LÓGICA PRINCIPAL DE LA APP ---
            airportChart.onload = () => { imageError.style.display = 'none'; airportChart.style.opacity = '1'; };
            airportChart.onerror = () => { imageError.style.display = 'flex'; airportChart.style.opacity = '0'; };
            
            loadCustomChartBtn.addEventListener('click', () => chartFileInput.click());
            chartFileInput.addEventListener('change', event => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = e => { airportChart.src = e.target.result; currentAirportName.textContent = 'Carta Personalizada';
                        lemdBtn.classList.replace('bg-blue-600', 'bg-gray-600'); legtBtn.classList.replace('bg-blue-600', 'bg-gray-600'); };
                    reader.readAsDataURL(file);
                }
            });

            function selectAirport(airportCode) {
                const isCustomChart = airportChart.src.startsWith('data:image');
                currentAirportCode = airportCode;
                const airportData = airports[airportCode];
                if (!isCustomChart) { airportChart.style.opacity = '0'; imageError.style.display = 'none'; airportChart.src = airportData.imageUrl; }
                currentAirportName.textContent = airportData.name + (isCustomChart ? ' (Coords)' : '');
                if (airportCode === 'LEMD') { lemdBtn.classList.replace('bg-gray-600', 'bg-blue-600'); legtBtn.classList.replace('bg-blue-600', 'bg-gray-600'); } 
                else { legtBtn.classList.replace('bg-gray-600', 'bg-blue-600'); lemdBtn.classList.replace('bg-blue-600', 'bg-gray-600'); }
                userDot.style.display = 'none';
                statusText.textContent = `Coordenadas de ${airportCode} aplicadas. Esperando ubicación...`;
                resetViewBtn.click(); // Restablece el zoom al cambiar de aeropuerto
            }

            function onPositionUpdate(position) {
                permissionModal.style.display = 'none';
                if (!currentAirportCode) return;
                const { latitude, longitude } = position.coords;
                const { bounds } = airports[currentAirportCode];
                statusText.textContent = "Ubicación actualizada.";
                coordsText.textContent = `Lat: ${latitude.toFixed(6)}, Lon: ${longitude.toFixed(6)}`;

                if (latitude <= bounds.top && latitude >= bounds.bottom && longitude >= bounds.left && longitude <= bounds.right) {
                    const percentX = (longitude - bounds.left) / (bounds.right - bounds.left);
                    const percentY = (1 - ((latitude - bounds.bottom) / (bounds.top - bounds.bottom))); // Invertido para Y
                    
                    userDot.style.left = `${percentX * 100}%`;
                    userDot.style.top = `${percentY * 100}%`;
                    userDot.style.display = 'block';
                } else {
                    userDot.style.display = 'none';
                    statusText.textContent = "Estás fuera del área del aeropuerto seleccionado.";
                }
            }
            
            // Corrección en el cálculo del eje Y. La latitud crece hacia arriba.
            function onPositionUpdate(position) {
                permissionModal.style.display = 'none';
                if (!currentAirportCode) return;
                const { latitude, longitude } = position.coords;
                const { bounds } = airports[currentAirportCode];
                statusText.textContent = "Ubicación actualizada.";
                coordsText.textContent = `Lat: ${latitude.toFixed(6)}, Lon: ${longitude.toFixed(6)}`;

                if (latitude <= bounds.top && latitude >= bounds.bottom && longitude >= bounds.left && longitude <= bounds.right) {
                    const percentX = (longitude - bounds.left) / (bounds.right - bounds.left);
                    // El eje Y en HTML va de arriba (0%) a abajo (100%).
                    // La latitud va de abajo (bottom) a arriba (top).
                    // Por lo tanto, necesitamos invertir el cálculo para Y.
                    const percentY = (bounds.top - latitude) / (bounds.top - bounds.bottom);
                    
                    userDot.style.left = `${percentX * 100}%`;
                    userDot.style.top = `${percentY * 100}%`;
                    userDot.style.display = 'block';
                } else {
                    userDot.style.display = 'none';
                    statusText.textContent = "Estás fuera del área del aeropuerto seleccionado.";
                }
            }


            function onPositionError(error) {
                let msg;
                switch (error.code) {
                    case error.PERMISSION_DENIED: msg = "Permiso de geolocalización denegado."; permissionModal.style.display = 'flex'; break;
                    case error.POSITION_UNAVAILABLE: msg = "La información de ubicación no está disponible."; break;
                    case error.TIMEOUT: msg = "La solicitud de ubicación ha caducado."; break;
                    default: msg = 'Error desconocido al obtener la ubicación.';
                }
                statusText.textContent = msg;
            }

            lemdBtn.addEventListener('click', () => selectAirport('LEMD'));
            legtBtn.addEventListener('click', () => selectAirport('LEGT'));
            reloadBtn.addEventListener('click', () => location.reload());
            selectAirport('LEMD');

            if ('geolocation' in navigator) {
                navigator.geolocation.watchPosition(onPositionUpdate, onPositionError, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
            } else {
                statusText.textContent = 'La geolocalización no es compatible con tu navegador.';
            }
        });
    </script>
</body>
</html>

